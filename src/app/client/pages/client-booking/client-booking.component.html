<div class="booking-container">
  <!-- Header with Logo -->
  <div class="booking-header">
    <div class="logo-container">
      <div class="logo-placeholder">
        <i class="pi pi-calendar" style="font-size: 2rem"></i>
      </div>
      <h1>Reserva tu Turno</h1>
    </div>
    <p class="subtitle">Agenda tu cita de manera fácil y rápida</p>
  </div>

  <!-- Progress Steps -->
  <div class="steps-container">
    <div class="steps-wrapper">
      <div
        class="step"
        *ngFor="let step of steps; let i = index"
        [class.active]="step.active"
        [class.completed]="step.completed"
        [class.clickable]="i + 1 <= currentStep()"
        (click)="goToStep(step.id)"
      >
        <div class="step-number">
          <i *ngIf="step.completed" class="pi pi-check"></i>
          <span *ngIf="!step.completed">{{ step.id }}</span>
        </div>
        <div class="step-title">{{ step.title }}</div>
      </div>
    </div>
  </div>

  <!-- Main Content Card -->
  <div class="main-card">
    <!-- Step 1: Date Selection -->
    <div *ngIf="currentStep() === 1" class="step-content date-selection">
      <div class="step-header">
        <h2>Selecciona una Fecha</h2>
        <p>Elige el día que prefieras para tu cita</p>
      </div>

      <div class="calendar-wrapper">
        <p-calendar
          [(ngModel)]="selectedDate"
          [inline]="true"
          [minDate]="minDate!"
          (onSelect)="onDateSelect($event)"
          [showOtherMonths]="false"
          [selectOtherMonths]="false"
          styleClass="custom-calendar"
        >
        </p-calendar>
      </div>

      <div class="help-text">
        <i class="pi pi-info-circle"></i>
        <span>Solo se muestran las fechas con horarios disponibles</span>
      </div>
    </div>

    <!-- Step 2: Time Selection -->
    <div *ngIf="currentStep() === 2" class="step-content time-selection">
      <div class="step-header">
        <h2><i class="pi pi-clock"></i> Selecciona un Horario</h2>
        <p>{{ formatDate(selectedDate()!) }}</p>
      </div>

      <div class="loading-container" *ngIf="isLoading()">
        <p-skeleton
          height="60px"
          styleClass="mb-3"
          *ngFor="let item of [1, 2, 3, 4]"
        ></p-skeleton>
      </div>

      <div class="time-slots-grid" *ngIf="!isLoading()">
        <div
          class="time-slot"
          *ngFor="let slot of timeSlots()"
          [class.selected]="selectedSlot()?.id === slot.id"
          (click)="selectTimeSlot(slot)"
          pRipple
        >
          <div class="time-display">
            {{ formatTime(slot.startTime) }} - {{ formatTime(slot.endTime) }}
          </div>
          <div class="slot-info">
            <span class="available-badge">Disponible</span>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="!isLoading() && timeSlots().length === 0">
        <i class="pi pi-calendar-times"></i>
        <h3>No hay horarios disponibles</h3>
        <p>Intenta seleccionar otra fecha</p>
      </div>

      <div class="navigation-buttons">
        <p-button
          label="Anterior"
          icon="pi pi-arrow-left"
          severity="secondary"
          (click)="previousStep()"
        >
        </p-button>
      </div>
    </div>

    <!-- Step 3: Personal Information -->
    <div *ngIf="currentStep() === 3" class="step-content form-section">
      <div class="step-header">
        <h2><i class="pi pi-user"></i>Tus Datos</h2>
        <p>Completa la información para confirmar tu turno</p>
      </div>

      <form [formGroup]="bookingForm">
        <div class="form-grid">
          <div class="field">
            <label for="name">Nombre Completo *</label>
            <input
              id="name"
              type="text"
              pInputText
              formControlName="name"
              placeholder="Tu nombre completo"
              [readonly]="isClientRegistered"
              [class.ng-invalid]="
                bookingForm.get('name')?.invalid &&
                bookingForm.get('name')?.touched
              "
            />
            <small
              class="error-message"
              *ngIf="
                bookingForm.get('name')?.invalid &&
                bookingForm.get('name')?.touched
              "
            >
              El nombre es requerido y debe tener al menos 2 caracteres
            </small>
          </div>

          <div class="field">
            <label for="dni">DNI *</label>
            <input
              id="dni"
              type="text"
              pInputText
              formControlName="dni"
              placeholder="Tu número de documento"
              [readonly]="isClientRegistered"
              [class.ng-invalid]="
                bookingForm.get('dni')?.invalid &&
                bookingForm.get('dni')?.touched
              "
            />
            <small
              class="error-message"
              *ngIf="
                bookingForm.get('dni')?.invalid &&
                bookingForm.get('dni')?.touched
              "
            >
              DNI debe tener entre 7 y 10 dígitos
            </small>
          </div>

          <div class="field">
            <label for="email">Email *</label>
            <input
              id="email"
              type="email"
              pInputText
              formControlName="clientEmail"
              placeholder="tu@email.com"
              [readonly]="isClientRegistered"
              [class.ng-invalid]="
                bookingForm.get('clientEmail')?.invalid &&
                bookingForm.get('clientEmail')?.touched
              "
            />
            <small
              class="error-message"
              *ngIf="
                bookingForm.get('clientEmail')?.invalid &&
                bookingForm.get('clientEmail')?.touched
              "
            >
              Ingresa un email válido
            </small>

            <small
              class="error-message"
              *ngIf="
                bookingForm.get('clientEmail')?.hasError('required') &&
                bookingForm.get('clientEmail')?.touched
              "
            >
              El email es requerido
            </small>
          </div>

          <div class="field">
            <label for="phone">Teléfono *</label>
            <input
              id="phone"
              type="tel"
              pInputText
              formControlName="clientPhoneNumber"
              placeholder="+54 9 11 1234-5678"
              [readonly]="isClientRegistered"
              [class.ng-invalid]="
                bookingForm.get('clientPhoneNumber')?.invalid &&
                bookingForm.get('clientPhoneNumber')?.touched
              "
            />
            <small
              class="error-message"
              *ngIf="
                bookingForm.get('clientPhoneNumber')?.hasError('required') &&
                bookingForm.get('clientPhoneNumber')?.touched
              "
            >
              El teléfono es requerido
            </small>
          </div>

          <div class="field full-width">
            <label for="description">Comentarios adicionales</label>
            <textarea
              id="description"
              pInputTextarea
              formControlName="description"
              placeholder="Algún detalle adicional que quieras agregar..."
              rows="3"
              [autoResize]="true"
              [readonly]="isClientRegistered"
            >
            </textarea>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="form-progress">
          <div class="progress-info">
            <span>Progreso del formulario</span>
            <span>{{ getFormProgress() }}%</span>
          </div>
          <p-progressBar
            [value]="getFormProgress()"
            [showValue]="false"
            styleClass="custom-progress"
          >
          </p-progressBar>
        </div>
      </form>

      @if(isCanClient){
      <p>
        <i class="pi pi-lock"></i>
        Por favor, ingresa una contraseña para ser cliente. Utilizaremos su
        email para el usuario.
      </p>
      <div class="register-container input-password">
        <input
          id="password"
          type="password"
          pInputText
          placeholder="Ingrese una contraseña"
          class="w-8"
          [(ngModel)]="password"
        />
        <p-button
          label="Registrarse"
          icon="pi pi-user-plus"
          severity="secondary"
          (click)="submitClientRegister()"
        >
        </p-button>
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          (click)="isCanClient = false"
        >
        </p-button>
      </div>
      }

      <div class="navigation-buttons">
        <p-button
          label="Anterior"
          icon="pi pi-arrow-left"
          severity="secondary"
          (click)="previousStep()"
        >
        </p-button>
        <p-button
          label="Quiero ser cliente"
          icon="pi pi-user-plus"
          severity="secondary"
          (click)="isCanClient = true"
        >
        </p-button>
        <p-button
          label="Confirmar Turno"
          icon="pi pi-check"
          [disabled]="!bookingForm.valid"
          [loading]="isLoading()"
          (click)="onSubmit()"
        >
        </p-button>
      </div>
    </div>

    <!-- Step 4: Confirmation -->
    <div *ngIf="currentStep() === 4" class="step-content confirmation">
      <div class="confirmation-content">
        <div class="success-icon">
          <i class="pi pi-check-circle"></i>
        </div>

        <h2>¡Turno Confirmado!</h2>
        <p>Tu cita ha sido reservada exitosamente</p>

        <div class="appointment-summary">
          <div class="summary-item">
            <i class="pi pi-calendar"></i>
            <div>
              <strong>Fecha</strong>
              <span>{{ formatDate(selectedDate()!) }}</span>
            </div>
          </div>

          <div class="summary-item">
            <i class="pi pi-clock"></i>
            <div>
              <strong>Horario</strong>
              <span
                >{{ formatTime(selectedSlot()!.startTime) }} -
                {{ formatTime(selectedSlot()!.endTime) }}</span
              >
            </div>
          </div>

          <div class="summary-item">
            <i class="pi pi-user"></i>
            <div>
              <strong>Nombre</strong>
              <span>{{ bookingForm.get("name")?.value }}</span>
            </div>
          </div>

          <div
            class="summary-item"
            *ngIf="bookingForm.get('clientEmail')?.value"
          >
            <i class="pi pi-envelope"></i>
            <div>
              <strong>Email</strong>
              <span>{{ bookingForm.get("clientEmail")?.value }}</span>
            </div>
          </div>
        </div>

        <div class="confirmation-actions">
          <p-button
            label="Nuevo Turno"
            icon="pi pi-plus"
            severity="secondary"
            (click)="resetBooking()"
          >
          </p-button>
        </div>

        <div class="help-note">
          <i class="pi pi-info-circle"></i>
          <span
            >Recibirás una confirmación por email si proporcionaste tu
            dirección</span
          >
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Messages -->
<p-toast position="top-center" [life]="5000"></p-toast>
